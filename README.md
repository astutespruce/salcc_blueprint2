# SALCC Blueprint 2.2


## Data processing

Data are provided as a file geodatabase (GDB) by SALCC staff:
* Indicators: Blueprint_V_2_2_SimpleViewerInterfaceData_20180720.7z (7/20/2018)
* Threats (IGNORE SLR, replaced by below): SimpleViewerInterfaceDataThreats.7z  (4/3/2018)
* Updated SLR: NOAA_SLR_Inundation.7z (8/22/2018)


We also obtain the US Census TIGER States shapefile to extract state and county FIPS codes for each watershed.

1. extract the geodatabase and shapefile to CSVs using `export_tables.py`.  (CSVs are version controlled, clear out the directory and regenerate for a new version of the Blueprint)
2. convert the CSVs to a JSON file for each watershed / marine block using `extract_data`.
3. the output JSON files are stored in `public/data` which is not versioned due to the volume of files.


## Tiles
All tile layers are generating using [`datatiles`](https://github.com/brendan-ward/datatiles).  

The visible Blueprint tiles are generated by rendering the Blueprint TIF to tiles using the standard colors for the Blueprint categories.

Data tiles are created for the indicators and Blueprint.  They are currently binned into 4 tilesets based on their value range using the
`exponential` data tiles encoder.

TODO: Documentation on the configuration is under development.

Tiles are stored locally in `tiles` in this repository but are not versioned due to size.


## Development

The following instructions assume that you have first:
* run `yarn install` to install all depedencies.  Building mapbox-gl-native from source may take a long time.
* run `pipenv install` to setup a Python virtual environment and install all dependencies.

You will likely need several environment variables set.  Create a file `.env` in the root of this project, based on the `.env.example` file.
Note: Flask does not use these variables, they need to be provided manually on the command line.

To start the frontend application (on port 3000, by default:
`yarn start`
Then open `http://localhost:3000` in your browser.

To start the report server (on port 5000, by default):
```
export FLASK_APP=api
pipenv run flask run
```
Alternatively, you can run flask from within your virtual environment:
```
pipenv shell
flask run
```

To confirm it is running, go to `http://localhost:5000/report/I1` in your browser, which should trigger a download of a word doc.


To start the map generation server (on port 8000, by default, using tiles hosted in /tiles):
```
mbgl-server -t ./tiles
```

To confirm that it is running, open `http://localhost:8000/render` in your browser.  It should give you a 400 error message about required parameters.

If you get a command not found error, you might need to execute the local binary file:
`./node_modules/.bin/mbgl-server -t ./tiles`


## Deployment

The production system is an EC2 instance in AWS.  That system runs a static fileserver to serve
the React front-end application over HTTPS, `mbtileserver` to provide the map tiles, `flask` to 
provide the report API, and `mbgl-server` to provide map rendering for the reports.

The server currently runs Caddy as the reverse proxy and static fileserver.

Server configuration steps are available in the [wiki](https://github.com/consbio/salcc_blueprint2/wiki).
